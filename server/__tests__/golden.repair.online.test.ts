import { describe, it, expect } from "vitest";
import { spawnSync } from "child_process";
import { readFileSync, readdirSync } from "fs";
import { join } from "path";

describe("Golden Repair Online Test (Real Models)", () => {
  it.skipIf(!process.env.AIML_API_KEY || process.env.ALLOW_NETWORK_TESTS !== "1")("should run full swarm pipeline with real API calls", async () => {
    const fixturePacket = join(
      __dirname,
      "../../runs/fixtures/failurePackets/v1/minimal.json"
    );

    // Run auto-repair with real swarm (calls AIML API)
    // Use spawnSync to capture output and never fail silently
    const repoRoot = join(__dirname, "../..");
    const result = spawnSync(
      "pnpm",
      ["swarm:fix", "--from", fixturePacket, "--apply", "--test"],
      {
        cwd: repoRoot,
        env: {
          ...process.env,
          AI_PROVIDER: "aiml",
          ALLOW_NETWORK_TESTS: "1",
          PATH: process.env.PATH ?? "",
          HOME: process.env.HOME ?? "",
        },
        stdio: "pipe",
        encoding: "utf8",
        timeout: 180000, // 3 minutes for API calls
      }
    );

    console.log("[swarm:fix] status:", result.status);
    console.log("[swarm:fix] stdout:", result.stdout?.slice(0, 2000));
    console.log("[swarm:fix] stderr:", result.stderr?.slice(0, 2000));

    if (result.error) {
      console.error("[swarm:fix] error:", result.error);
      throw result.error;
    }

    // Find the latest repair run
    const repairDir = join(__dirname, "../../runs/repair");
    const repairRuns = readdirSync(repairDir)
      .filter((d) => d.startsWith("repair_"))
      .sort()
      .reverse();

    expect(repairRuns.length).toBeGreaterThan(0);

    const latestRun = repairRuns[0];
    const repairPacketPath = join(repairDir, latestRun, "repairPacket.json");
    const repairPacket = JSON.parse(readFileSync(repairPacketPath, "utf8"));

    // Assert repairPacket was generated by swarm (not offline mode)
    expect(repairPacket).toBeDefined();
    expect(repairPacket.diagnosis).toBeDefined();
    expect(repairPacket.diagnosis.likelyCause).toBeDefined();
    expect(repairPacket.patchPlan).toBeDefined();

    // Assert PASS criteria
    expect(repairPacket.execution).toBeDefined();
    expect(repairPacket.execution.patchValid).toBe(true);
    expect(repairPacket.execution.applied).toBe(true);
    expect(repairPacket.execution.testsPassed).toBe(true);
    expect(repairPacket.execution.stopReason).toBe("ok");

    console.log(`âœ… Golden online test PASSED (${latestRun})`);
    console.log(`   Diagnosis: ${repairPacket.diagnosis.likelyCause}`);
    console.log(`   Confidence: ${repairPacket.diagnosis.confidence}`);
  }, 200000); // 3.5 minute timeout for entire test
});
