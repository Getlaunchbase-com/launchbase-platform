/**
 * LaunchBase Email Service
 * Production-ready email templates for the post-intake sequence
 */

import { getDb } from "./db";
import { emailLogs } from "../drizzle/schema";
import { notifyOwner } from "./_core/notification";
import { Resend } from "resend";
import { ENV } from "./_core/env";

// Lazy initialization: read env at runtime (not module load)
let resendClient: Resend | null = null;
function getResendClient(): Resend | null {
  console.log(`[Email Debug] ENV.resendApiKey: ${ENV.resendApiKey ? 'SET (len=' + ENV.resendApiKey.length + ')' : 'NOT SET'}`);
  if (!ENV.resendApiKey) {
    console.log(`[Email Debug] Resend client: NULL (no API key)`);
    return null;
  }
  if (!resendClient) {
    console.log(`[Email Debug] Creating new Resend client...`);
    resendClient = new Resend(ENV.resendApiKey);
  }
  console.log(`[Email Debug] Returning Resend client: ${resendClient ? 'INITIALIZED' : 'NULL'}`);
  return resendClient;
}

// Email configuration
const FROM_EMAIL = process.env.FROM_EMAIL || "LaunchBase <noreply@launchbase.app>";
const REPLY_TO_EMAIL = process.env.REPLY_TO_EMAIL || "support@launchbase.app";

// Email template types
export type EmailType = 
  | "intake_confirmation"
  | "in_progress"
  | "ready_for_review"
  | "review_nudge"
  | "deployment_started"
  | "site_live"
  | "preview_followup"
  | "testimonial_request"
  | "founding_client_lockin"
  | "day7_checkin"
  | "day30_value";

interface EmailData {
  firstName: string;
  businessName: string;
  email: string;
  previewUrl?: string;
  liveUrl?: string;
  checkoutLink?: string;
}

interface EmailTemplate {
  subject: string;
  previewText: string;
  body: string;
}

// Generate email templates based on type and data
export function getEmailTemplate(type: EmailType, data: EmailData): EmailTemplate {
  const { firstName, businessName, previewUrl, liveUrl } = data;
  
  switch (type) {
    // ========== POST-INTAKE SEQUENCE ==========
    
    case "intake_confirmation":
      return {
        subject: "âœ… We're building your website",
        previewText: "Your LaunchBase site is officially in progress.",
        body: `Hi ${firstName},

Thanks for completing your LaunchBase intake.

We're now building your website based on the information you provided. Our system handles the structure, copy, and layout â€” and a real human reviews everything before it's ready.

What happens next:
â€¢ We build your site
â€¢ We review it for quality
â€¢ You'll receive a link to preview and approve

Estimated turnaround: 24â€“72 hours
(No payment required to review.)

If you have questions in the meantime, just reply to this email.

â€”
ðŸ’° Know someone who needs a website? Refer a friend and you'll both save $50.
https://getlaunchbase.com/referrals

â€”
LaunchBase
The operating system for launching service businesses`
      };

    case "in_progress":
      return {
        subject: "ðŸ‘· Your site is in progress",
        previewText: "Just a quick update â€” everything is on track.",
        body: `Hi ${firstName},

Just a quick update â€” your website is currently being built.

Nothing is needed from you right now. We're assembling the layout, copy, and features based on your intake and reviewing everything before it's ready.

You'll receive another email as soon as your preview is available.

â€”
LaunchBase`
      };

    case "ready_for_review":
      return {
        subject: "Your site preview is ready",
        previewText: "Nothing is published yet â€” review your preview and let us know.",
        body: `Hi ${firstName},

Your LaunchBase preview is ready to review.

Nothing is published yet â€” this is your chance to confirm everything looks right.

ðŸ‘‰ Review your preview:
${previewUrl || "[Preview URL]"}

If you want changes, reply to this email and we'll adjust it before launch.

â€”
LaunchBase
Workflows that give you back your life.`
      };

    case "review_nudge":
      return {
        subject: "Just checking in â€” your site is ready",
        previewText: "No rush, just making sure you saw it.",
        body: `Hi ${firstName},

Just checking in to make sure you saw your site preview.

ðŸ‘‰ ${previewUrl || "[Preview URL]"}

There's no rush â€” we just want to be sure everything looks right before launch.

If you have questions or want changes, reply here and we'll take care of it.

â€”
LaunchBase`
      };

    case "deployment_started":
      return {
        subject: "We received payment â€” deployment has started",
        previewText: "Your site is being deployed now.",
        body: `Hi ${firstName},

We received your payment â€” thank you.

Your site is now being deployed. Here's what's happening:

1. Provisioning your template
2. Applying your branding
3. Publishing to the web
4. Connecting your domain (if applicable)

You'll receive another email as soon as your site is live.

â€”
LaunchBase
Workflows that give you back your life.`
      };

    case "site_live":
      return {
        subject: "Your site is live â€” and you don't need to manage it",
        previewText: "LaunchBase has taken over. Here's what that means.",
        body: `Hi ${firstName},

Your site is live â€” and you don't need to manage it.

ðŸ‘‰ View your site:
${liveUrl || "[Live URL]"}

From this moment, LaunchBase is carrying:

â€¢ Monitoring â€” we're watching uptime, performance, and availability
â€¢ Decisions â€” we determine when action is safe and relevant
â€¢ Waiting â€” sometimes the right move is no move at all
â€¢ Protecting â€” safety rules are always enforced, without exception

Nothing happens silently.
Every action is visible in your dashboard.
Non-action is always safe.

You can stop thinking about this.

If you ever need changes or have questions, reply to this email. We're here.

â€”
LaunchBase
Workflows that give you back your life.`
      };

    // ========== FOUNDING CLIENT FOLLOW-UP ==========

    case "preview_followup":
      return {
        subject: "Just checking in â€” happy to make changes",
        previewText: "Take a look when you have a moment.",
        body: `Hi ${firstName},

Just checking in to see if you had a chance to review your site.

ðŸ‘‰ ${previewUrl || "[Preview URL]"}

If you'd like any tweaks or changes, just reply here â€” happy to adjust anything before launch.

No rush at all.

â€”
LaunchBase`
      };

    case "testimonial_request":
      return {
        subject: "Quick question (2 minutes)",
        previewText: "Would love your feedback.",
        body: `Hi ${firstName},

Quick question â€” if LaunchBase saved you time or helped you get online faster, would you be open to sharing a short testimonial?

A sentence or two is perfect. Nothing formal.

It really helps as we open this up to more businesses.

Thanks either way â€” and let us know if you need anything.

â€”
LaunchBase`
      };

    case "founding_client_lockin":
      return {
        subject: "You're officially a LaunchBase founding client",
        previewText: "Your pricing is locked in.",
        body: `Hi ${firstName},

Quick note to say thank you.

As we prepare to open LaunchBase publicly, you're officially locked in as a Founding Client.

That means:
â€¢ Your pricing never changes
â€¢ You keep priority support
â€¢ Your feedback continues to shape the platform

We appreciate you trusting us early.

â€”
LaunchBase`
      };

    // ========== CUSTOMER SUCCESS ==========

    case "day7_checkin":
      return {
        subject: "Everything looking good?",
        previewText: "Just checking in on your site.",
        body: `Hi ${firstName},

Just checking in to make sure everything looks good with your site.

If you want any small tweaks or changes, feel free to reply here.

â€”
LaunchBase`
      };

    case "day30_value":
      return {
        subject: "Quick note from LaunchBase",
        previewText: "Your subscription covers hosting, updates, and support.",
        body: `Hi ${firstName},

Just a quick note â€” your LaunchBase subscription covers hosting, updates, and ongoing support for your site.

If you ever need changes or improvements, just reply here.

Thanks again for trusting us.

â€”
LaunchBase`
      };

    default:
      return {
        subject: "Update from LaunchBase",
        previewText: "You have a message from LaunchBase.",
        body: `Hi ${firstName},

Thank you for using LaunchBase.

â€”
LaunchBase`
      };
  }
}

// Send email and log it
export async function sendEmail(
  intakeId: number,
  type: EmailType,
  data: EmailData
): Promise<boolean> {
  const template = getEmailTemplate(type, data);
  
  try {
    // Log the email attempt
    const db = await getDb();
    if (!db) {
      console.error("[Email] Database not available");
      return false;
    }
    
    // Try to send via Resend if configured
    let emailSent = false;
    const resend = getResendClient();
    if (resend) {
      try {
        const result = await resend.emails.send({
          from: FROM_EMAIL,
          to: data.email,
          replyTo: REPLY_TO_EMAIL,
          subject: template.subject,
          text: template.body,
          // HTML version with basic formatting
          html: `
            <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
              ${template.body.split('\n').map(line => 
                line.startsWith('â€¢') 
                  ? `<p style="margin: 8px 0; padding-left: 16px;">${line}</p>`
                  : line === '' 
                    ? '<br/>'
                    : `<p style="margin: 16px 0; line-height: 1.6;">${line}</p>`
              ).join('')}
            </div>
          `,
        });
        
        if (result.data?.id) {
          emailSent = true;
          console.log(`[Email] Sent via Resend: ${type} to ${data.email} (ID: ${result.data.id})`);
        }
      } catch (resendError) {
        console.error(`[Email] Resend failed, falling back to notification:`, resendError);
      }
    }
    
    // Fallback: Use notification system if Resend not configured or failed
    if (!emailSent) {
      const emailContent = `
**To:** ${data.email}
**Subject:** ${template.subject}

---

${template.body}
      `.trim();
      
      await notifyOwner({
        title: `ðŸ“§ ${template.subject}`,
        content: emailContent,
      });
      
      console.log(`[Email] Sent via notification: ${type} to ${data.email}`);
    }
    
    // Log success
    await db.insert(emailLogs).values({
      intakeId,
      emailType: type,
      recipientEmail: data.email,
      subject: template.subject,
      status: "sent",
    });
    
    console.log(`[Email] Subject: ${template.subject}`);
    
    // Additional owner notification for important events
    if (type === "intake_confirmation") {
      await notifyOwner({
        title: `ðŸŽ‰ New intake: ${data.businessName}`,
        content: `${data.firstName} (${data.email}) just completed an intake for ${data.businessName}. Ready for build plan generation.`,
      });
    }
    
    return true;
  } catch (error) {
    console.error(`[Email] Failed to send ${type} to ${data.email}:`, error);
    
    // Log the failure
    const dbFail = await getDb();
    if (dbFail) {
      await dbFail.insert(emailLogs).values({
        intakeId,
        emailType: type,
        recipientEmail: data.email,
        subject: template.subject,
        status: "failed",
      });
    }
    
    return false;
  }
}

// Send admin notification
export async function sendAdminNotification(
  title: string,
  content: string
): Promise<boolean> {
  try {
    await notifyOwner({ title, content });
    return true;
  } catch (error) {
    console.error("[Admin Notification] Failed:", error);
    return false;
  }
}

// Admin notification helpers
export const AdminNotifications = {
  newIntake: (businessName: string, confidence: number) => 
    sendAdminNotification(
      "New intake received",
      `${businessName} â€” ready for build plan generation. Confidence: ${confidence}%`
    ),
  
  lowConfidence: (businessName: string, confidence: number) =>
    sendAdminNotification(
      "Intake requires clarification",
      `${businessName} has low confidence (${confidence}%). Review before building.`
    ),
  
  siteApproved: (businessName: string) =>
    sendAdminNotification(
      "Site approved",
      `${businessName} approved their site. Ready to deploy.`
    ),
  
  deploymentComplete: (businessName: string, url: string) =>
    sendAdminNotification(
      "Site deployed",
      `${businessName} is now live at ${url}`
    ),
};
