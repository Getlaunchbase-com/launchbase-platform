{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "DecisionCollapse",
  "description": "Final decision after AI tennis rounds - picks ONE winner",
  "type": "object",
  "required": ["schemaVersion", "selectedProposal", "reason", "approvalText", "previewRecommended", "needsHuman", "confidence", "requiresApproval", "roundLimit", "costCapUsd"],
  "additionalProperties": false,
  "properties": {
    "schemaVersion": {
      "type": "string",
      "const": "v1",
      "description": "Schema version for safe migrations"
    },
    "selectedProposal": {
      "description": "The winning proposal (null if needsHuman=true)",
      "oneOf": [
        {
          "type": "object",
          "description": "Copy proposal variant",
          "required": ["type", "targetKey", "value"],
          "additionalProperties": false,
          "properties": {
            "type": {
              "type": "string",
              "const": "copy"
            },
            "targetKey": {
              "type": "string",
              "description": "Exactly one whitelisted key",
              "enum": [
                "hero.headline",
                "hero.subheadline",
                "hero.cta",
                "trust.items",
                "services.items",
                "socialProof.reviews",
                "socialProof.outcomes"
              ]
            },
            "value": {
              "description": "Proposed value (string or array)"
            }
          }
        },
        {
          "type": "object",
          "description": "Design tokens proposal",
          "required": ["type", "tokens"],
          "additionalProperties": false,
          "properties": {
            "type": {
              "type": "string",
              "const": "design"
            },
            "tokens": {
              "type": "object",
              "description": "Design tokens object"
            }
          }
        },
        {
          "type": "null"
        }
      ]
    },
    "reason": {
      "type": "string",
      "maxLength": 300,
      "description": "Why this proposal was selected (or why needsHuman)"
    },
    "approvalText": {
      "type": "string",
      "maxLength": 200,
      "description": "Short text for customer approval email"
    },
    "previewRecommended": {
      "type": "boolean",
      "description": "True if preview should be generated before approval"
    },
    "needsHuman": {
      "type": "boolean",
      "description": "True if no safe proposal could be selected"
    },
    "needsHumanReason": {
      "type": "string",
      "maxLength": 200,
      "description": "Why human intervention is needed (if needsHuman=true)"
    },
    "confidence": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "Confidence in final decision"
    },
    "requiresApproval": {
      "type": "boolean",
      "const": true,
      "description": "Must always be true"
    },
    "roundLimit": {
      "type": "number",
      "minimum": 0,
      "maximum": 2,
      "description": "Max AI tennis rounds (hard cap at 2)"
    },
    "costCapUsd": {
      "type": "number",
      "minimum": 0,
      "maximum": 10,
      "description": "Max cost in USD for this job (hard cap at $10)"
    },
    "actualRounds": {
      "type": "number",
      "minimum": 0,
      "maximum": 2,
      "description": "Actual rounds executed"
    },
    "estimatedCostUsd": {
      "type": "number",
      "minimum": 0,
      "description": "Estimated cost of this job"
    },
    "assumptions": {
      "type": "array",
      "description": "Assumptions made during decision process",
      "items": {
        "type": "string",
        "maxLength": 120
      },
      "maxItems": 5
    }
  }
}
